<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEDEMA ¬∑ Tablero de Priorizaci√≥n</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <!-- Fuente Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Estilos -->
  <link href="styles.css" rel="stylesheet" />
</head>
<body>

<header>
  <div class="header-inner">
    <div class="header-logos">
      <img src="logo_manzanas_verdes.png" alt="SEDEMA" class="logo-sedema-manzanas">
    </div>
    <div class="header-texto">
      <h1>SEDEMA ¬∑ Manzanas por colonia</h1>
      <p>Tablero de consulta de prioridades e intervenci√≥n territorial.</p>
    </div>
  </div>
</header>

<main class="container">

  <!-- ============================================ -->
  <!-- BLOQUE 1: DIAGN√ìSTICO GENERAL (MACRO) -->
  <!-- ============================================ -->
  <section class="section-block section-macro">
    <h2>Diagn√≥stico General de la Ciudad de M√©xico</h2>
    <p class="intro-text">Panorama estad√≠stico de las necesidades de intervenci√≥n territorial y justicia social en la capital.</p>

    <!-- KPIs Est√°ticos -->
    <div class="kpi-global-section">
      <div class="kpi-global-card">
        <div class="kpi-icon">üèôÔ∏è</div>
        <div class="kpi-content">
          <div class="kpi-global-label">Total Colonias</div>
          <div class="kpi-global-value">2,148</div>
          <small class="kpi-subtext">Cobertura CDMX</small>
        </div>
      </div>
      <div class="kpi-global-card alert">
        <div class="kpi-icon">‚ö†Ô∏è</div>
        <div class="kpi-content">
          <div class="kpi-global-label">Colonias Alta + Muy Alta</div>
          <div class="kpi-global-value">452</div>
          <small class="kpi-subtext">21% del total</small>
        </div>
      </div>
      <div class="kpi-global-card alert">
        <div class="kpi-icon">üë•</div>
        <div class="kpi-content">
          <div class="kpi-global-label">Poblaci√≥n Prioritaria</div>
          <div class="kpi-global-value">2,105,300</div>
          <small class="kpi-subtext">25% de la pob. total</small>
        </div>
      </div>
      <div class="kpi-global-card">
        <div class="kpi-icon">üìê</div>
        <div class="kpi-content">
          <div class="kpi-global-label">Sup. Prioritaria (ha)</div>
          <div class="kpi-global-value">15,400</div>
          <small class="kpi-subtext">Alta + Muy Alta</small>
        </div>
      </div>
    </div>

    <!-- Gr√°ficas de Contexto (Est√°ticas) -->
    <div class="charts-wrapper">
      <div class="chart-card">
        <h4 title="Validaci√≥n de Justicia Social">¬øLas colonias prioritarias son las m√°s marginadas?</h4>
        <div class="chart-container-box">
          <canvas id="chartJusticia"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h4>Top 5 Alcald√≠as con mayor urgencia (Ha Muy Alta)</h4>
        <div class="chart-container-box">
          <canvas id="chartRanking"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- BLOQUE 2: TERRITORIO (MAPA) -->
  <!-- ============================================ -->
  <section class="map-section section-block">
    <div class="map-header">
      <h3>Exploraci√≥n Territorial</h3>
      <button id="btnFullscreenOpen" class="btn-fullscreen">‚§¢ Pantalla completa</button>
    </div>

    <div class="map-wrapper" id="mapWrapper">
      <button id="btnFullscreenClose" class="btn-close-map">‚úñ Salir de pantalla completa</button>
      <div id="map"></div>
      <div id="mapLoading" class="map-loading">Cargando mapa...</div>

      <!-- LEYENDA GLOBAL -->
      <div class="map-legend">
        <div class="legend-title">Simbolog√≠a</div>
        <div class="legend-simple-item">
          <span class="legend-color colonias-color"></span> <span class="legend-label">L√≠mite Colonia</span>
        </div>
        <div class="legend-simple-item">
          <span class="legend-color manzanas-sel-color"></span> <span class="legend-label">Manzanas (Selecci√≥n)</span>
        </div>
        <div class="legend-subtitle">Capas Globales (Ciudad Completa)</div>
        <p class="legend-guide">Selecciona un nivel para visualizarlo en todo el mapa.</p>
        
        <div class="legend-group">
          <!-- Botones Leyenda -->
          <div class="legend-row"><div class="legend-info"><span class="legend-color prio-muy-baja"></span><span class="legend-label">Muy baja</span></div><div class="legend-actions"><button class="legend-btn" data-prio="muy baja" data-target="colonias">Colonia</button><button class="legend-btn" data-prio="muy baja" data-target="manzanas">Manzana</button></div></div>
          <div class="legend-row"><div class="legend-info"><span class="legend-color prio-baja"></span><span class="legend-label">Baja</span></div><div class="legend-actions"><button class="legend-btn" data-prio="baja" data-target="colonias">Colonia</button><button class="legend-btn" data-prio="baja" data-target="manzanas">Manzana</button></div></div>
          <div class="legend-row"><div class="legend-info"><span class="legend-color prio-media"></span><span class="legend-label">Media</span></div><div class="legend-actions"><button class="legend-btn" data-prio="media" data-target="colonias">Colonia</button><button class="legend-btn" data-prio="media" data-target="manzanas">Manzana</button></div></div>
          <div class="legend-row"><div class="legend-info"><span class="legend-color prio-alta"></span><span class="legend-label">Alta</span></div><div class="legend-actions"><button class="legend-btn" data-prio="alta" data-target="colonias">Colonia</button><button class="legend-btn" data-prio="alta" data-target="manzanas">Manzana</button></div></div>
          <div class="legend-row"><div class="legend-info"><span class="legend-color prio-muy-alta"></span><span class="legend-label">Muy alta</span></div><div class="legend-actions"><button class="legend-btn" data-prio="muy alta" data-target="colonias">Colonia</button><button class="legend-btn" data-prio="muy alta" data-target="manzanas">Manzana</button></div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- BLOQUE 3: CONSULTA CIUDADANA (MICRO) -->
  <!-- ============================================ -->
  <section class="section-block section-micro">
    <h2>Consulta el Estatus de tu Colonia</h2>
    <p class="intro-text">Busca tu colonia para obtener un <strong>Diagn√≥stico Personalizado</strong> y compararlo con tu alcald√≠a.</p>

    <div class="form-grid">
      <div class="form-item">
        <label for="munSelector">1. Alcald√≠a</label>
        <select id="munSelector"><option value="">Selecciona...</option></select>
      </div>
      <div class="form-item">
        <label for="colInput">2. Colonia</label>
        <input id="colInput" list="colList" placeholder="Escribe para buscar..." disabled>
        <datalist id="colList"></datalist>
      </div>
    </div>

    <!-- TARJETA DE DIAGN√ìSTICO (Aparece al seleccionar) -->
    <div id="diagnosticoContainer" class="diagnostic-wrapper" style="display:none;">
      <!-- Se llena con JS -->
    </div>

    <!-- TABLA DE DATOS -->
    <div class="table-section-inner">
      <div class="table-header-row">
        <h3>Explorador de Datos Detallado</h3>
        <button id="btnLimpiarFiltros" class="btn-clear-table">Restablecer filtros</button>
      </div>
      <div id="filtroNarrativo" class="filtro-narrativo">Viendo todas las colonias.</div>
      
      <div class="table-wrapper">
        <table id="tablaColonias">
          <thead>
            <tr>
              <th data-col="alc">Alcald√≠a ‚Üï<br><select id="filtroAlc"><option value="">Todas</option></select></th>
              <th data-col="col">Colonia ‚Üï<br><input id="filtroCol" type="text" placeholder="Buscar..."></th>
              <th data-col="manz">No. Manzanas ‚Üï</th>
              <th data-col="prio">Prioridad ‚Üï<br><select id="filtroPrio"><option value="">Todas</option></select></th>
              <th data-col="gm">Marginaci√≥n ‚Üï<br><select id="filtroGM"><option value="">Todos</option></select></th>
              <th data-col="pob">Poblaci√≥n ‚Üï</th>
              <th data-col="ha">Superficie (ha) ‚Üï</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="tablaConteo" class="tabla-resumen-footer"></div>
    </div>
  </section>

</main>
<!-- ============================================ -->
<!-- BLOQUE FINAL: KPIs CENTRO HIST√ìRICO -->
<!-- ============================================ -->
<section class="section-block section-centro" id="centroSection">
  <h2>Centro Hist√≥rico ¬∑ Indicadores del pol√≠gono</h2>
  <p class="intro-text">
    Resumen autom√°tico con base en intersecci√≥n espacial (Centro.geojson vs colonias/manzanas).
  </p>

  <div id="centroKPIs" class="kpi-global-section"></div>

  <div class="table-section-inner">
    <div class="table-header-row">
      <h3>Distribuci√≥n por prioridad</h3>
    </div>
    <div class="table-wrapper">
      <table id="tablaCentroPrioridad">
        <thead>
          <tr>
            <th>Prioridad</th>
            <th>Colonias</th>
            <th>Manzanas</th>
            <th>Poblaci√≥n (sum)</th>
            <th>Superficie (ha)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="centroNota" class="tabla-resumen-footer"></div>
  </div>
</section>

<footer>
  <p>Gobierno de la Ciudad de M√©xico ¬∑ SEDEMA 2025</p>
</footer>

<!-- Librer√≠as -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ============================================
// CONFIGURACI√ìN Y VARIABLES
// ============================================
let coloniasFeatures = [], manzanasFeatures = [], coloniasAgg = [];
let manzanasPorColoniaMap = {}; 
let map, baseLight, baseOSM, baseSat;
let capaColonias, capaManzanasTodas, capaManzanasResaltadas;
let capaColoniasPrioridad, capaManzanasPrioridad;
  let capaCentro;
let indiceColonias = {};
let manzanaInfoControl, userMarker;
let currentSort = { col: null, dir: 'asc' };
let chartJusticia = null, chartRanking = null;
  let centroFeature = null;   // <- geometr√≠a (pol√≠gono) unificada del Centro Hist√≥rico

// Escala Num√©rica para c√°lculos de promedio/ranking
const SCORES_PRIORIDAD = { "muy baja": 1, "baja": 2, "media": 3, "alta": 4, "muy alta": 5 };

// ============================================
// HELPERS
// ============================================
function normalizarTexto(str) {
  if (!str) return "";
  const fixes = { "TL?HUAC": "TL√ÅHUAC", "?LVARO OBREG?N": "√ÅLVARO OBREG√ìN" };
  const raw = String(str).trim();
  return fixes[raw] || raw;
}
function normalizarPrioridad(str) { return (str || "").toString().toLowerCase().trim(); }

function estiloPrioridad(p) {
  const c = { "muy baja":"#006100", "baja":"#7aab00", "media":"#ffff00", "alta":"#ff9900", "muy alta":"#ff2200" };
  const k = normalizarPrioridad(p);
  const color = c[k] || "#ccc";
  return { color: color, fill: color };
}

function prioridadClass(p) {
  const pr = normalizarPrioridad(p);
  if (pr === "muy baja") return "prio-muy-baja";
  if (pr === "baja") return "prio-baja";
  if (pr === "media") return "prio-media";
  if (pr === "alta") return "prio-alta";
  if (pr === "muy alta") return "prio-muy-alta";
  return "prio-desconocida";
}

function showLoading(show) { 
  const el = document.getElementById('mapLoading'); 
  if(el) el.style.display = show ? 'flex' : 'none'; 
}

// ============================================
// MAPA
// ============================================
function initMap() {
  map = L.map('map', { zoomControl: false }).setView([19.35, -99.13], 11);
  L.control.zoom({ position: 'topright' }).addTo(map);

  // PANES (Z-Index Fix)
  map.createPane('coloniasPane'); map.getPane('coloniasPane').style.zIndex = 350; 
  map.createPane('manzanasPane'); map.getPane('manzanasPane').style.zIndex = 450; 
  map.createPane('resaltadoPane'); map.getPane('resaltadoPane').style.zIndex = 500; 
  map.createPane('centroPane');
map.getPane('centroPane').style.zIndex = 520; // arriba de colonias/manzanas

  capaCentro = L.geoJSON(null, {
  pane: 'centroPane',
  pointToLayer: (feature, latlng) => {
    return L.circleMarker(latlng, {
      radius: 6,
      weight: 2,
      color: "#111827",
      fillColor: "#00a3ff",
      fillOpacity: 0.9
    });
  },
  style: { color: "#00a3ff", weight: 3, fillOpacity: 0.1 }, // por si viene como pol√≠gonos/l√≠neas
  onEachFeature: (f, l) => {
    const name = f?.properties?.NOMBRE || f?.properties?.name || "Centro";
    l.bindPopup(`<b>${name}</b>`);
  }
});


  baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'OSM' });
  baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: 'Carto' });
  baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Esri' });
  baseLight.addTo(map);

  const myRenderer = L.canvas({ padding: 0.5 });

  // CAPAS
  capaColonias = L.geoJSON(null, {
    pane: 'coloniasPane',
    style: { color: "#55585a", weight: 1, fillOpacity: 0 }, 
    onEachFeature: (f, l) => {
      const k = `${normalizarTexto(f.properties.NOM_MUN)}|${normalizarTexto(f.properties.COLONIA)}`;
      indiceColonias[k] = l;
      l.on('click', () => {
         const entry = coloniasAgg.find(c => c.key === k);
         if(entry) resaltarColoniaYManzanas(entry);
      });
    }
  }).addTo(map);

  capaManzanasTodas = L.geoJSON(null, {
    pane: 'manzanasPane',
    renderer: myRenderer,
    interactive: true,
    style: { color: "#aaaaaa", weight: 0.2, fillColor: "#cccccc", fillOpacity: 0.15 },
    onEachFeature: (f, l) => {
      l.on('mouseover', () => actualizarPanelManzana(f.properties));
      l.on('click', () => actualizarPanelManzana(f.properties));
    }
  }).addTo(map);

  capaManzanasResaltadas = L.geoJSON(null, {
    pane: 'resaltadoPane',
    renderer: myRenderer,
    interactive: true,
    style: f => {
      const s = estiloPrioridad(f.properties.PRIORIDAD);
      return { color: "#333", weight: 0.5, fillColor: s.fill, fillOpacity: 0.8 };
    },
    onEachFeature: (f, l) => {
      l.on('mouseover', () => actualizarPanelManzana(f.properties));
      l.on('click', () => actualizarPanelManzana(f.properties));
    }
  }).addTo(map);

  capaColoniasPrioridad = L.geoJSON(null, {
    pane: 'coloniasPane', 
    style: f => ({ color: estiloPrioridad(f.properties.prioridad).color, weight: 2, fillOpacity: 0.4 }),
    onEachFeature: (f,l) => {
      l.on('click', () => {
         const k = `${normalizarTexto(f.properties.NOM_MUN)}|${normalizarTexto(f.properties.COLONIA)}`;
         const entry = coloniasAgg.find(c => c.key === k);
         if(entry) resaltarColoniaYManzanas(entry);
      });
    }
  }).addTo(map);

  capaManzanasPrioridad = L.geoJSON(null, {
    pane: 'manzanasPane', 
    renderer: myRenderer,
    interactive: true,
    style: f => ({ color: "#444", weight: 0.2, fillColor: estiloPrioridad(f.properties.PRIORIDAD).fill, fillOpacity: 0.7 }),
    onEachFeature: (f,l) => {
       l.on('mouseover', () => actualizarPanelManzana(f.properties));
       l.on('click', () => actualizarPanelManzana(f.properties));
    }
  }).addTo(map);

 L.control.layers(
  {"Mapa Claro": baseLight, "Sat√©lite": baseSat, "Calles": baseOSM},
  {"Colonias": capaColonias, "Manzanas": capaManzanasTodas, "Centro": capaCentro},
  {position:'topright'}
).addTo(map);

  // GEOCODER
  const geocoder = L.Control.Geocoder.nominatim({
    geocodingQueryParams: { countrycodes: 'mx', viewbox: '-99.36,19.59,-98.94,19.04', bounded: 1 }
  });
  L.Control.geocoder({
    defaultMarkGeocode: false,
    placeholder: "Buscar calle...",
    geocoder: geocoder,
    suggestMinLength: 3
  }).on('markgeocode', function(e) {
    const center = e.geocode.center;
    map.setView(center, 17);
    L.popup().setLatLng(center).setContent(e.geocode.name).openOn(map);
    seleccionarColoniaEnPunto(center.lat, center.lng);
  }).addTo(map);

  // BOT√ìN UBICACI√ìN
  const lc = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: () => {
      const b = L.DomUtil.create('button', 'btn-locate');
      b.innerHTML = 'üìç';
      b.title = "Ir a mi ubicaci√≥n";
      b.onclick = () => map.locate({setView:true, maxZoom:17});
      return b;
    }
  });
  map.addControl(new lc());

  map.on('locationfound', e => {
    if(userMarker) map.removeLayer(userMarker);
    userMarker = L.marker(e.latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
    seleccionarColoniaEnPunto(e.latlng.lat, e.latlng.lng);
  });

  // PANEL INFO
  manzanaInfoControl = L.control({ position: 'bottomright' });
  manzanaInfoControl.onAdd = () => {
    const div = L.DomUtil.create('div', 'manzana-info');
    div.innerHTML = '<b>Info. Manzana</b><br><i>Pasa el cursor...</i>';
    return div;
  };
  manzanaInfoControl.addTo(map);
}

function actualizarPanelManzana(p) {
  const div = manzanaInfoControl.getContainer();
  const cls = prioridadClass(p.PRIORIDAD);
  div.className = 'manzana-info ' + cls;
  if(!p.CVEGEO) { div.innerHTML = '<b>Info. Manzana</b><br><i>Pasa el cursor...</i>'; return; }
  div.innerHTML = `<b>ID:</b> ${p.CVEGEO}<br><b>Colonia:</b> ${normalizarTexto(p.COLONIA)}<br><b>Prioridad:</b> <span class="badge-prioridad ${cls}">${p.PRIORIDAD}</span><br><b>Pob:</b> ${Number(p.POB||0).toLocaleString()}<br><small>${p.Inf_Azul || ''}</small>`;
}

// ============================================
// DATOS
// ============================================
function initData() {
 Promise.all([
  fetch('colonias_manzanas_verdes.geojson').then(r=>r.json()),
  fetch('manzanas_manzanas_verdes.geojson').then(r=>r.json()),
  fetch('Centro.geojson').then(r=>r.json()) // <-- pon aqu√≠ tu nombre real
]).then(([colD, manzD, centroD]) => {
    coloniasFeatures = colD.features;
    manzanasFeatures = manzD.features;

    capaColonias.addData(coloniasFeatures);
    capaManzanasTodas.addData(manzanasFeatures);
capaCentro.addData(centroD);
capaCentro.addTo(map); // opcional: si quieres que prenda por default

   // ====== NORMALIZAR CENTRO: FeatureCollection -> un solo pol√≠gono (union) ======
centroFeature = (function buildCentroFeature(gj){
  if (!gj) return null;

  // Si viene FeatureCollection, usa union para tener un solo pol√≠gono (si hay varios)
  if (gj.type === 'FeatureCollection') {
    const feats = (gj.features || []).filter(f => f && f.geometry);
    if (feats.length === 0) return null;
    let merged = feats[0];
    for (let i = 1; i < feats.length; i++) {
      try { merged = turf.union(merged, feats[i]); } catch(e) { /* si falla union, ignorar esa pieza */ }
    }
    return merged;
  }

  // Si viene Feature suelto
  if (gj.type === 'Feature' && gj.geometry) return gj;

  // Si viene geometry suelta
  if (gj.type && gj.coordinates) return { type: 'Feature', properties: {}, geometry: gj };

  return null;
})(centroD);

   
    manzanasPorColoniaMap = {};
    const counts = {};

    manzanasFeatures.forEach(f => {
      const k = `${normalizarTexto(f.properties.NOM_MUN)}|${normalizarTexto(f.properties.COLONIA)}`;
      counts[k] = (counts[k] || 0) + 1;
      if (!manzanasPorColoniaMap[k]) manzanasPorColoniaMap[k] = [];
      manzanasPorColoniaMap[k].push(f);
    });

    coloniasAgg = coloniasFeatures.map((f, i) => {
      const p = f.properties;
      const k = `${normalizarTexto(p.NOM_MUN)}|${normalizarTexto(p.COLONIA)}`;
      // Convertir a score num√©rico
      const score = SCORES_PRIORIDAD[normalizarPrioridad(p.prioridad)] || 0;
      
      return {
        idx: i, key: k,
        nom_mun: normalizarTexto(p.NOM_MUN),
        colonia: normalizarTexto(p.COLONIA),
        prio_colonia: (p.prioridad || "Sin dato").trim(),
        score_prio: score, // Nuevo campo num√©rico
        gm_2020: p.GM_2020 || "Sin dato",
        pob_colonia: p.POBTOT ? Math.round(p.POBTOT) : 0,
        area_ha: (p.area_km2 || 0) * 100,
        n_manz: counts[k] || 0
      };
    });

    llenarSelects();
    renderStaticCharts(coloniasAgg); // Graficas Macro Est√°ticas
    actualizarTabla();
   calcularYRenderCentroHistorico(); // <- AQU√ç: ya con todo cargado
  });
}


function llenarSelects() {
    const alcs = [...new Set(coloniasAgg.map(c=>c.nom_mun))].sort();
    alcs.forEach(a => {
      document.getElementById('munSelector').add(new Option(a,a));
      document.getElementById('filtroAlc').add(new Option(a,a));
    });
    // Filtros manuales para orden l√≥gico
    const ordenP = { "muy baja": 1, "baja": 2, "media": 3, "alta": 4, "muy alta": 5 };
    const ps = [...new Set(coloniasAgg.map(c=>c.prio_colonia))].sort((a,b)=> (ordenP[normalizarPrioridad(a)]||99)-(ordenP[normalizarPrioridad(b)]||99));
    ps.forEach(p => document.getElementById('filtroPrio').add(new Option(p,p)));
    const ordenGM = { "muy bajo": 1, "bajo": 2, "medio": 3, "alto": 4, "muy alto": 5 };
    const gs = [...new Set(coloniasAgg.map(c=>c.gm_2020))].sort((a,b)=> (ordenGM[a.toLowerCase()]||99)-(ordenGM[b.toLowerCase()]||99));
    gs.forEach(g => document.getElementById('filtroGM').add(new Option(g,g)));
}

// ============================================
// L√ìGICA DE DIAGN√ìSTICO (NUEVO)
// ============================================
function generarDiagnostico(entry) {
  // 1. Filtrar colonias de la misma alcald√≠a
  const colDeAlc = coloniasAgg.filter(c => c.nom_mun === entry.nom_mun);
  
  // 2. Calcular promedio de prioridad en la alcald√≠a
  const sumScores = colDeAlc.reduce((acc, curr) => acc + curr.score_prio, 0);
  const avgScore = sumScores / colDeAlc.length;
  
  // Texto de Comparativa
  let textoBrecha = "";
  let claseBrecha = "";
  if (entry.score_prio > avgScore) {
    textoBrecha = `‚ö†Ô∏è <strong>Brecha de Atenci√≥n:</strong> Tu colonia tiene prioridad <strong>${entry.prio_colonia.toUpperCase()}</strong>, mayor al promedio de ${entry.nom_mun}. Requiere atenci√≥n prioritaria.`;
    claseBrecha = "alert-bad";
  } else if (entry.score_prio < avgScore) {
    textoBrecha = `‚úÖ <strong>Zona Privilegiada:</strong> Tu prioridad es mejor que el promedio de tu alcald√≠a. Es vital conservar las √°reas verdes existentes.`;
    claseBrecha = "alert-good";
  } else {
    textoBrecha = `‚öñÔ∏è <strong>Acorde al Promedio:</strong> La situaci√≥n es similar al resto de la alcald√≠a.`;
    claseBrecha = "alert-neutral";
  }

  // 3. Ranking de Urgencia (Ordenar por Score descendente, luego Pob descendente)
  const ranking = colDeAlc.sort((a,b) => {
    if (b.score_prio !== a.score_prio) return b.score_prio - a.score_prio;
    return b.pob_colonia - a.pob_colonia;
  });
  const rankPosition = ranking.findIndex(r => r.key === entry.key) + 1;

  // 4. Doble Vulnerabilidad
  let textoVulnerabilidad = "";
  const gm = (entry.gm_2020 || "").toLowerCase();
  const prio = normalizarPrioridad(entry.prio_colonia);
  const isPrioAlta = (prio === "alta" || prio === "muy alta");
  const isMargAlta = (gm === "alto" || gm === "muy alto");

  if (isPrioAlta && isMargAlta) {
    textoVulnerabilidad = `<div class="diag-item critic">üÜò <strong>Doble Vulnerabilidad:</strong> Se detecta Alta Marginaci√≥n + Falta de Infraestructura Verde. Intervenci√≥n cr√≠tica por justicia social.</div>`;
  }

  // Renderizar Tarjeta
  const prClass = prioridadClass(entry.prio_colonia);
  const html = `
    <div class="diagnostic-card">
      <div class="diag-header">
        <h3>Diagn√≥stico: ${entry.colonia}</h3>
        <span class="badge-prioridad ${prClass}">${entry.prio_colonia}</span>
      </div>
      <div class="diag-body">
        <div class="diag-item ${claseBrecha}">${textoBrecha}</div>
        ${textoVulnerabilidad}
        <div class="diag-item">
          üìä <strong>Ranking de Urgencia:</strong> Ocupa el puesto <strong>#${rankPosition} de ${colDeAlc.length}</strong> en ${entry.nom_mun}.
        </div>
        <div class="diag-item">
          üë• <strong>Impacto:</strong> Una intervenci√≥n beneficiar√≠a a <strong>${entry.pob_colonia.toLocaleString()}</strong> habitantes directos.
        </div>
      </div>
    </div>
  `;
  
  const container = document.getElementById('diagnosticoContainer');
  container.innerHTML = html;
  container.style.display = 'block';
  
  // Scroll suave al diagn√≥stico
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ============================================
// INTERACCI√ìN Y RENDER
// ============================================

function seleccionarColoniaEnPunto(lat, lng) {
  if (coloniasFeatures.length === 0) return;
  const pt = turf.point([lng, lat]);
  const featureFound = coloniasFeatures.find(f => turf.booleanPointInPolygon(pt, f));
  if (featureFound) {
    const p = featureFound.properties;
    const key = `${normalizarTexto(p.NOM_MUN)}|${normalizarTexto(p.COLONIA)}`;
    const entry = coloniasAgg.find(c => c.key === key);
    if (entry) resaltarColoniaYManzanas(entry);
  }
}

function resaltarColoniaYManzanas(entry) {
  if (!entry) return;
  const layer = indiceColonias[entry.key];
  if (!layer) return;

  showLoading(true);
  capaColonias.resetStyle();
  capaColonias.eachLayer(l => l.closePopup());

  layer.setStyle({ color: "#b28e5c", weight: 4, fillOpacity: 0 });
  layer.bringToFront(); 

  const prClass = prioridadClass(entry.prio_colonia);
  const popupHtml = `
    <div class="popup-colonia-wrapper">
      <div class="popup-colonia-header ${prClass}">
        ${entry.colonia}
      </div>
      <div class="popup-colonia-body">
        <b>Alcald√≠a:</b> ${entry.nom_mun}<br>
        <b>Prioridad:</b> <span class="badge-prioridad ${prClass}">${entry.prio_colonia}</span><br>
        <b>Marginaci√≥n:</b> ${entry.gm_2020}<br>
        <b>Ranking Local:</b> Consultar tarjeta<br>
      </div>
    </div>`;

  layer.bindPopup(popupHtml, { className: 'popup-colonia', minWidth: 240 }).openPopup();
  map.fitBounds(layer.getBounds(), { padding: [50,50] });

  const manzanasDeLaColonia = manzanasPorColoniaMap[entry.key] || [];
  capaManzanasResaltadas.clearLayers();
  if (manzanasDeLaColonia.length > 0) {
    capaManzanasResaltadas.addData(manzanasDeLaColonia);
  }
  
  // GENERAR DIAGN√ìSTICO
  generarDiagnostico(entry);
  
  showLoading(false);
  document.getElementById('munSelector').value = entry.nom_mun;
}

function actualizarTabla() {
  const fAlc = document.getElementById('filtroAlc').value;
  const fCol = document.getElementById('filtroCol').value.toLowerCase();
  const fPrio = document.getElementById('filtroPrio').value;
  const fGM = document.getElementById('filtroGM').value;

  const narr = [];
  if(fAlc) narr.push(`Alcald√≠a <strong>${fAlc}</strong>`);
  if(fPrio) narr.push(`Prioridad <strong>${fPrio}</strong>`);
  if(fGM) narr.push(`Marginaci√≥n <strong>${fGM}</strong>`);
  if(fCol) narr.push(`b√∫squeda "${fCol}"`);
  
  const textoNarrativo = narr.length > 0 ? "Filtros: " + narr.join(" + ") : "Viendo todas las colonias.";
  document.getElementById('filtroNarrativo').innerHTML = textoNarrativo;

  let d = coloniasAgg.filter(r => 
    (!fAlc || r.nom_mun === fAlc) &&
    (!fCol || r.colonia.toLowerCase().includes(fCol)) &&
    (!fPrio || r.prio_colonia === fPrio) &&
    (!fGM || r.gm_2020 === fGM)
  );

  if (currentSort.col) {
    const {col, dir} = currentSort;
    const m = dir === 'asc' ? 1 : -1;
    d.sort((a,b) => {
      const va=a[col], vb=b[col];
      return (typeof va === 'number' ? va-vb : String(va).localeCompare(String(vb))) * m;
    });
  }

  const tbody = document.querySelector('#tablaColonias tbody');
  let html = "";
  // Limitar renderizado por seguridad
  const displayData = d.length > 300 ? d.slice(0, 300) : d;
  
  displayData.forEach(r => {
    html += `<tr data-idx="${r.idx}">
      <td>${r.nom_mun}</td>
      <td>${r.colonia}</td>
      <td>${r.n_manz}</td>
      <td><span class="prio-dot ${prioridadClass(r.prio_colonia)}"></span>${r.prio_colonia}</td>
      <td>${r.gm_2020}</td>
      <td>${r.pob_colonia.toLocaleString()}</td>
      <td>${r.area_ha.toFixed(2)}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
  document.getElementById('tablaConteo').innerText = `${d.length} colonias (Mostrando primeras 300).`;
}

// === GR√ÅFICAS EST√ÅTICAS (MACRO) ===
function renderStaticCharts(data) {
  // Chart 1: Justicia Social
  const marginacionOrden = ["muy bajo", "bajo", "medio", "alto", "muy alto"];
  const prioridades = ["muy baja", "baja", "media", "alta", "muy alta"];
  const prioColors = { "muy baja": "#006100", "baja": "#7aab00", "media": "#ffff00", "alta": "#ff9900", "muy alta": "#ff2200" };

  const datasetsJusticia = prioridades.map(prio => ({
    label: prio.toUpperCase(),
    data: new Array(marginacionOrden.length).fill(0),
    backgroundColor: prioColors[prio]
  }));

  data.forEach(item => {
    const marg = (item.gm_2020 || "").toLowerCase();
    const prio = normalizarPrioridad(item.prio_colonia);
    const mIdx = marginacionOrden.indexOf(marg);
    const pIdx = prioridades.indexOf(prio);
    if (mIdx !== -1 && pIdx !== -1) datasetsJusticia[pIdx].data[mIdx]++;
  });

  if(chartJusticia) chartJusticia.destroy();
  chartJusticia = new Chart(document.getElementById('chartJusticia'), {
    type: 'bar',
    data: { labels: marginacionOrden.map(m => m.toUpperCase()), datasets: datasetsJusticia },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
  });

  // Chart 2: Ranking Alcald√≠as (Muy Alta)
  const muyAltaData = data.filter(i => normalizarPrioridad(i.prio_colonia) === "muy alta");
  const alcMap = {};
  muyAltaData.forEach(i => {
    if(!alcMap[i.nom_mun]) alcMap[i.nom_mun] = 0;
    alcMap[i.nom_mun] += i.area_ha;
  });
  const sorted = Object.keys(alcMap).map(k=>({n:k, v:alcMap[k]})).sort((a,b)=>b.v-a.v).slice(0,5);

  if(chartRanking) chartRanking.destroy();
  chartRanking = new Chart(document.getElementById('chartRanking'), {
    type: 'bar',
    data: { 
      labels: sorted.map(d=>d.n), 
      datasets: [{ label: 'Has. Muy Alta', data: sorted.map(d=>d.v), backgroundColor: '#e5074c' }] 
    },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display:false } } }
  });
}


function calcularYRenderCentroHistorico() {
  if (!centroFeature || !centroFeature.geometry) {
    document.getElementById('centroNota').innerText = 'No se pudo leer Centro.geojson (no hay geometr√≠a).';
    return;
  }
  if (!coloniasFeatures?.length || !manzanasFeatures?.length) return;

  // Helper: intersecci√≥n segura
  const intersects = (a, b) => {
    try { return turf.booleanIntersects(a, b); } catch(e) { return false; }
  };

  const centro = centroFeature;

  // ====== Filtrar por intersecci√≥n ======
  const coloniasCentro = coloniasFeatures.filter(f => f?.geometry && intersects(f, centro));
  const manzanasCentro = manzanasFeatures.filter(f => f?.geometry && intersects(f, centro));

  // ====== Agregados generales ======
  const nColonias = coloniasCentro.length;
  const nManzanas = manzanasCentro.length;

  const pobColonias = coloniasCentro.reduce((acc, f) => acc + (Number(f?.properties?.POBTOT) || 0), 0);
  const pobManzanas = manzanasCentro.reduce((acc, f) => acc + (Number(f?.properties?.POB) || 0), 0);

  const haColonias = coloniasCentro.reduce((acc, f) => {
    const km2 = Number(f?.properties?.area_km2) || 0;
    return acc + (km2 * 100);
  }, 0);

  // Si tus manzanas no tienen √°rea, este queda en 0 (no invento dato)
  const haManzanas = manzanasCentro.reduce((acc, f) => {
    const km2 = Number(f?.properties?.area_km2) || 0;
    return acc + (km2 * 100);
  }, 0);

  // ====== Distribuci√≥n por prioridad ======
  const prios = ["muy baja","baja","media","alta","muy alta"];
  const dist = {};
  prios.forEach(p => dist[p] = { colonias: 0, manzanas: 0, pob: 0, ha: 0 });

  coloniasCentro.forEach(f => {
    const p = normalizarPrioridad(f?.properties?.prioridad);
    if (!dist[p]) return;
    dist[p].colonias++;
    dist[p].pob += (Number(f?.properties?.POBTOT) || 0);
    dist[p].ha  += ((Number(f?.properties?.area_km2) || 0) * 100);
  });

  manzanasCentro.forEach(f => {
    const p = normalizarPrioridad(f?.properties?.PRIORIDAD);
    if (!dist[p]) return;
    dist[p].manzanas++;
    dist[p].pob += (Number(f?.properties?.POB) || 0);
    dist[p].ha  += ((Number(f?.properties?.area_km2) || 0) * 100);
  });

  // ====== Render KPIs ======
  const kpis = document.getElementById('centroKPIs');
  kpis.innerHTML = `
    <div class="kpi-global-card">
      <div class="kpi-icon">üèòÔ∏è</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Colonias en Centro</div>
        <div class="kpi-global-value">${nColonias.toLocaleString()}</div>
        <small class="kpi-subtext">Intersecci√≥n espacial</small>
      </div>
    </div>
    <div class="kpi-global-card">
      <div class="kpi-icon">üß±</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Manzanas en Centro</div>
        <div class="kpi-global-value">${nManzanas.toLocaleString()}</div>
        <small class="kpi-subtext">Intersecci√≥n espacial</small>
      </div>
    </div>
    <div class="kpi-global-card alert">
      <div class="kpi-icon">üë•</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Poblaci√≥n (Colonias)</div>
        <div class="kpi-global-value">${pobColonias.toLocaleString()}</div>
        <small class="kpi-subtext">Suma POBTOT</small>
      </div>
    </div>
    <div class="kpi-global-card">
      <div class="kpi-icon">üìê</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Superficie (Colonias)</div>
        <div class="kpi-global-value">${haColonias.toFixed(1)}</div>
        <small class="kpi-subtext">ha (desde area_km2)</small>
      </div>
    </div>
  `;

  // ====== Render tabla por prioridad ======
  const tbody = document.querySelector('#tablaCentroPrioridad tbody');
  let rows = '';
  prios.forEach(p => {
    const d = dist[p];
    rows += `
      <tr>
        <td><span class="prio-dot ${prioridadClass(p)}"></span>${p.toUpperCase()}</td>
        <td>${d.colonias.toLocaleString()}</td>
        <td>${d.manzanas.toLocaleString()}</td>
        <td>${Math.round(d.pob).toLocaleString()}</td>
        <td>${d.ha.toFixed(2)}</td>
      </tr>
    `;
  });
  tbody.innerHTML = rows;

  // Nota metodol√≥gica (para blindaje institucional)
  document.getElementById('centroNota').innerText =
    `Notas: conteos por ‚Äúintersecci√≥n‚Äù (booleanIntersects). Poblaci√≥n de colonias = POBTOT. Poblaci√≥n de manzanas = POB. Superficie = area_km2*100 (si existe).`;
}

  
// EVENTOS
document.addEventListener('DOMContentLoaded', () => {
  initMap();
  initData();

  ['filtroAlc','filtroCol','filtroPrio','filtroGM'].forEach(id => 
    document.getElementById(id).addEventListener(id==='filtroCol'?'input':'change', actualizarTabla));

  document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
    ['filtroAlc','filtroCol','filtroPrio','filtroGM'].forEach(id => document.getElementById(id).value = "");
    actualizarTabla();
  });

  document.querySelector('#tablaColonias tbody').addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if(tr && tr.dataset.idx) {
      const item = coloniasAgg.find(i => i.idx == tr.dataset.idx);
      resaltarColoniaYManzanas(item);
      document.getElementById('map').scrollIntoView({behavior:'smooth'});
    }
  });

  document.getElementById('munSelector').addEventListener('change', e => {
    const alc = e.target.value;
    const l = document.getElementById('colList');
    const i = document.getElementById('colInput');
    l.innerHTML = ''; i.value = ''; i.disabled = !alc;
    if(alc) {
      coloniasAgg.filter(c=>c.nom_mun===alc).sort((a,b)=>a.colonia.localeCompare(b.colonia))
        .forEach(c => l.appendChild(new Option(c.colonia)));
    }
  });

  document.getElementById('colInput').addEventListener('change', e => {
    const alc = document.getElementById('munSelector').value;
    const item = coloniasAgg.find(c => c.nom_mun===alc && c.colonia===e.target.value);
    if(item) resaltarColoniaYManzanas(item);
  });

  const btnOpen = document.getElementById('btnFullscreenOpen');
  const btnClose = document.getElementById('btnFullscreenClose');
  const wrapper = document.getElementById('mapWrapper');

  btnOpen.addEventListener('click', () => {
    wrapper.classList.add('map-fullscreen');
    btnClose.style.display = 'block';
    map.invalidateSize();
  });
  btnClose.addEventListener('click', () => {
    wrapper.classList.remove('map-fullscreen');
    btnClose.style.display = 'none';
    map.invalidateSize();
  });

  document.querySelectorAll('.legend-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const isActive = btn.classList.contains('active');
      const target = btn.dataset.target;
      const prio = btn.dataset.prio;
      if (!isActive) {
        const otherTarget = target === 'colonias' ? 'manzanas' : 'colonias';
        const siblingBtn = document.querySelector(`.legend-btn[data-prio="${prio}"][data-target="${otherTarget}"]`);
        if (siblingBtn && siblingBtn.classList.contains('active')) siblingBtn.classList.remove('active');
      }
      if (isActive) btn.classList.remove('active'); else btn.classList.add('active');
      recargarCapasGlobales();
    });
  });
});

function recargarCapasGlobales() {
  showLoading(true);
  capaColoniasPrioridad.clearLayers();
  capaManzanasPrioridad.clearLayers();
  const activeBtns = document.querySelectorAll('.legend-btn.active');
  setTimeout(() => {
    activeBtns.forEach(btn => {
      const p = btn.dataset.prio;
      const t = btn.dataset.target;
      if (t === 'colonias') {
        const f = coloniasFeatures.filter(x => normalizarPrioridad(x.properties.prioridad) === p);
        capaColoniasPrioridad.addData(f);
      } else {
        const f = manzanasFeatures.filter(x => normalizarPrioridad(x.properties.PRIORIDAD) === p);
        capaManzanasPrioridad.addData(f);
      }
    });
    showLoading(false);
  }, 10);
}
</script>
</body>
</html>
