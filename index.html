<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEDEMA ¬∑ Manzanas por colonia</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Fuente Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Estilos propios -->
  <link href="styles.css" rel="stylesheet" />
</head>
<body>

<header>
  <div class="header-inner">
    <div class="header-logos">
      <img src="logo_manzanas_verdes.png" alt="SEDEMA ¬∑ Manzanas Verdes" class="logo-sedema-manzanas">
    </div>
    <div class="header-texto">
      <h1>SEDEMA ¬∑ Manzanas por colonia</h1>
      <p>Herramienta para consultar manzanas y prioridad de intervenci√≥n por colonia en la Ciudad de M√©xico.</p>
    </div>
  </div>
  <div class="linea-oro"></div>
</header>

<main class="container">

  <!-- Secci√≥n de ayuda -->
  <section class="intro-section section-block">
    <h2>¬øC√≥mo funciona esta herramienta?</h2>
    <p>Esta herramienta permite visualizar manzanas urbanas y su prioridad de intervenci√≥n en colonias de la Ciudad de M√©xico.</p>
    <ol class="intro-pasos">
      <li>Selecciona una <strong>alcald√≠a</strong>.</li>
      <li>Escribe y selecciona una <strong>colonia</strong> de la lista.</li>
      <li>Revisa el <strong>mapa</strong> para ver la ubicaci√≥n y las manzanas de la colonia.</li>
      <li>Usa la <strong>tabla</strong> para explorar todas las colonias y filtrar por <strong>prioridad</strong> y <strong>grado de marginaci√≥n</strong>.</li>
      <li>Consulta el <strong>resumen y las gr√°ficas</strong> para interpretar la informaci√≥n.</li>
    </ol>
  </section>

  <!-- KPIs globales -->
  <section class="kpi-global-section section-block">
    <div class="kpi-global-card">
      <div class="kpi-global-label">Colonias totales</div>
      <div id="kpiTotalColonias" class="kpi-global-value">‚Äì</div>
    </div>
    <div class="kpi-global-card">
      <div class="kpi-global-label">Colonias alta + muy alta</div>
      <div id="kpiColoniasAlta" class="kpi-global-value">‚Äì</div>
    </div>
    <div class="kpi-global-card">
      <div class="kpi-global-label">Poblaci√≥n alta + muy alta</div>
      <div id="kpiPobAlta" class="kpi-global-value">‚Äì</div>
    </div>
    <div class="kpi-global-card">
      <div class="kpi-global-label">Superficie alta + muy alta (ha)</div>
      <div id="kpiHaAlta" class="kpi-global-value">‚Äì</div>
    </div>
  </section>

  <!-- Consulta -->
  <section class="section-block">
    <h2>Consulta por alcald√≠a y colonia</h2>

    <div class="form-grid">
      <div class="form-item">
        <label for="munSelector">Alcald√≠a</label>
        <select id="munSelector"></select>
        <small class="hint">Elige una alcald√≠a para filtrar la lista de colonias.</small>
      </div>

      <div class="form-item">
        <label for="colInput">Colonia</label>
        <input id="colInput" list="colList" placeholder="Empieza a escribir el nombre de la colonia‚Ä¶" disabled>
        <datalist id="colList"></datalist>
        <small class="hint">Escribe parte del nombre y selecciona la colonia de la lista.</small>
      </div>
    </div>

    <!-- KPI de colonia seleccionada -->
    <section id="resultado" class="resultado" style="display:none;"></section>
  </section>

  <!-- MAPA -->
  <section class="map-section section-block">
    <h3>Mapa de colonias y manzanas</h3>

    <div class="map-wrapper" id="mapWrapper">
      <button id="btnFullscreen" class="btn-fullscreen" aria-label="Ver mapa en pantalla completa">
        ‚§¢ Ver mapa grande
      </button>

      <div id="map"></div>
      <div id="mapLoading" class="map-loading">Procesando manzanas‚Ä¶</div>

      <!-- LEYENDA -->
      <div class="map-legend">
        <div class="legend-title">Simbolog√≠a</div>

        <div class="legend-group">
          <div class="legend-item">
            <span class="legend-color colonias-color"></span>
            <span class="legend-label">Colonias (l√≠mites)</span>
          </div>
          <!-- CORREGIDO: Faltaba cerrar divs y agregar etiqueta -->
          <div class="legend-item">
            <span class="legend-color manzanas-sel-color"></span>
            <span class="legend-label">Manzanas (selecci√≥n)</span>
          </div>
        </div>

        <div class="legend-subtitle">Prioridad de intervenci√≥n</div>
        <div class="legend-group">
          <div class="legend-item">
            <span class="legend-color prio-muy-baja"></span>
            <span class="legend-label">Muy baja</span>
            <button class="legend-btn" data-prio="muy baja" data-target="colonias">Colonias</button>
            <button class="legend-btn" data-prio="muy baja" data-target="manzanas">Manzanas</button>
          </div>
          <div class="legend-item">
            <span class="legend-color prio-baja"></span>
            <span class="legend-label">Baja</span>
            <button class="legend-btn" data-prio="baja" data-target="colonias">Colonias</button>
            <button class="legend-btn" data-prio="baja" data-target="manzanas">Manzanas</button>
          </div>
          <div class="legend-item">
            <span class="legend-color prio-media"></span>
            <span class="legend-label">Media</span>
            <button class="legend-btn" data-prio="media" data-target="colonias">Colonias</button>
            <button class="legend-btn" data-prio="media" data-target="manzanas">Manzanas</button>
          </div>
          <div class="legend-item">
            <span class="legend-color prio-alta"></span>
            <span class="legend-label">Alta</span>
            <button class="legend-btn" data-prio="alta" data-target="colonias">Colonias</button>
            <button class="legend-btn" data-prio="alta" data-target="manzanas">Manzanas</button>
          </div>
          <div class="legend-item">
            <span class="legend-color prio-muy-alta"></span>
            <span class="legend-label">Muy alta</span>
            <button class="legend-btn" data-prio="muy alta" data-target="colonias">Colonias</button>
            <button class="legend-btn" data-prio="muy alta" data-target="manzanas">Manzanas</button>
          </div>
        </div>
        <p class="legend-help">
          Haz clic en <strong>Colonias</strong> o <strong>Manzanas</strong> para filtrar el mapa.
        </p>
      </div>
    </div>
  </section>

  <!-- TABLA -->
  <section class="table-section section-block">
    <h3>Colonias ‚Äì Prioridad, grado de marginaci√≥n y superficie</h3>
    <p class="hint">Usa los filtros en los encabezados para buscar.</p>

    <div class="table-filters-actions">
      <button id="btnLimpiarFiltros" class="btn-clear" aria-label="Limpiar filtros">
        üóë Limpiar filtros de la tabla
      </button>
    </div>

    <p id="tablaResumen" class="tabla-resumen"></p>

    <div class="table-wrapper">
      <table id="tablaColonias">
        <thead>
          <tr>
            <th data-col="alc" title="Ordenar">
              Alcald√≠a ‚Üï<br>
              <select id="filtroAlc"><option value="">Todas</option></select>
            </th>
            <th data-col="col" title="Ordenar">
              Colonia ‚Üï<br>
              <input id="filtroCol" type="text" placeholder="Filtrar‚Ä¶">
            </th>
            <th data-col="manz" title="Ordenar">No. Manzanas ‚Üï</th>
            <th data-col="prio" title="Ordenar">
              Prioridad ‚Üï<br>
              <select id="filtroPrio"><option value="">Todas</option></select>
            </th>
            <th data-col="gm" title="Ordenar">
              G. Marginaci√≥n ‚Üï<br>
              <select id="filtroGM"><option value="">Todos</option></select>
            </th>
            <th data-col="pob" title="Ordenar">Poblaci√≥n 2020 ‚Üï</th>
            <th data-col="ha" title="Ordenar">Superficie (ha) ‚Üï</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas din√°micas -->
        </tbody>
      </table>
    </div>
    
    <!-- RESUMEN GENERAL -->
    <section id="statsResumen" class="stats-section"></section>
  </section>

  <!-- AN√ÅLISIS (GR√ÅFICAS) -->
  <section class="analysis-section section-block">
    <h3>Distribuci√≥n por prioridad de intervenci√≥n</h3>
    <p class="hint">Gr√°ficas basadas en los filtros de la tabla actual.</p>

    <div class="charts-wrapper">
      <div class="chart-card">
        <h4 id="chartTitleColonias">Colonias por prioridad</h4>
        <canvas id="chartColonias"></canvas>
      </div>
      <div class="chart-card">
        <h4 id="chartTitlePoblacion">Poblaci√≥n por prioridad</h4>
        <canvas id="chartPoblacion"></canvas>
      </div>
    </div>
  </section>

  <!-- NOTAS METODOL√ìGICAS -->
  <section class="metodologia-section section-block">
    <h3>Notas metodol√≥gicas</h3>
    <ul class="metodologia-lista">
      <li><strong>Prioridad de intervenci√≥n:</strong> Diagn√≥stico territorial (infraestructura, espacio p√∫blico, socioambiental).</li>
      <li><strong>Grado de marginaci√≥n 2020:</strong> Indicador oficial GM_2020.</li>
      <li><strong>Superficie:</strong> Calculada en hect√°reas (ha).</li>
      <li><strong>Fuente:</strong> SEDEMA / Informaci√≥n oficial de CDMX.</li>
    </ul>
  </section>

</main>

<footer>
  <p>SEDEMA ¬∑ Herramienta de consulta interna.</p>
</footer>

<!-- JS libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// =======================
// VARIABLES GLOBALES
// =======================

let coloniasFeatures = [];
let manzanasFeatures = [];

let coloniasAgg = [];      
let map;
let baseOSM, baseLight, baseSat, baseEmpty;
let capaColonias, capaManzanasTodas, capaManzanasResaltadas;
let capaColoniasPrioridad, capaManzanasPrioridad;
let indiceColonias = {};   
let manzanaInfoControl;

let currentSort = { col: null, dir: 'asc' };
let chartColonias = null;
let chartPoblacion = null;

// Totales globales
let totalColoniasBase = 0;
let totalPobBase = 0;
let totalHaBase = 0;
let globalAltaMuyAltaColonias = 0;
let globalAltaMuyAltaPob = 0;
let globalAltaMuyAltaHa  = 0;

// Estado de botones leyenda
let activeLegendBtn = null;
let activePrioFilter = null;
let activePrioTarget = null;

// =======================
// UTILIDADES
// =======================

function normalizarTexto(str) {
  if (!str) return "";
  const fixes = { "TL?HUAC": "TL√ÅHUAC", "?LVARO OBREG?N": "√ÅLVARO OBREG√ìN" };
  const raw = String(str).trim();
  return fixes[raw] || raw;
}

function normalizarPrioridad(str) {
  return (str || "").toString().toLowerCase().trim();
}

function estiloPrioridad(prioridadRaw) {
  const prioridad = normalizarPrioridad(prioridadRaw);
  if (prioridad === "muy baja")  return { color:"#006100", fill:"#006100" };
  if (prioridad === "baja")      return { color:"#7aab00", fill:"#7aab00" };
  if (prioridad === "media")     return { color:"#ffff00", fill:"#ffff00" };
  if (prioridad === "alta")      return { color:"#ff9900", fill:"#ff9900" };
  if (prioridad === "muy alta")  return { color:"#ff2200", fill:"#ff2200" };
  return { color:"#b0b0b0", fill:"#b0b0b0" }; 
}

function prioridadClass(prioridadRaw) {
  const prioridad = normalizarPrioridad(prioridadRaw);
  if (prioridad === "muy baja")  return "prio-muy-baja";
  if (prioridad === "baja")      return "prio-baja";
  if (prioridad === "media")     return "prio-media";
  if (prioridad === "alta")      return "prio-alta";
  if (prioridad === "muy alta")  return "prio-muy-alta";
  return "prio-desconocida";
}

function showMapLoading(show) {
  const el = document.getElementById('mapLoading');
  if (el) el.style.display = show ? 'flex' : 'none';
}

function textoContextoFiltros() {
  const selAlc = document.getElementById('filtroAlc').value;
  const selPrio = document.getElementById('filtroPrio').value;
  const selGM = document.getElementById('filtroGM').value;

  let partes = [];
  if (selAlc) partes.push(`Alcald√≠a: ${selAlc}`);
  if (selPrio) partes.push(`Prioridad: ${selPrio}`);
  if (selGM) partes.push(`Marginaci√≥n: ${selGM}`);

  return partes.length === 0 ? "Ciudad completa" : partes.join(" ¬∑ ");
}

// =======================
// LOGICA DE DATOS
// =======================

function construirAgregadosColonias() {
  coloniasAgg = [];
  const manzanasPorColonia = {};

  // Contar manzanas
  manzanasFeatures.forEach((feat) => {
    const p = feat.properties || {};
    const key = `${normalizarTexto(p.NOM_MUN)}|${normalizarTexto(p.COLONIA)}`;
    manzanasPorColonia[key] = (manzanasPorColonia[key] || 0) + 1;
  });

  coloniasFeatures.forEach((feat, idx) => {
    const p = feat.properties || {};
    const alc = normalizarTexto(p.NOM_MUN);
    const col = normalizarTexto(p.COLONIA);
    const key = `${alc}|${col}`;

    const area_km2 = Number(p.area_km2) || 0;
    const pob = p.POBTOT != null ? Math.round(p.POBTOT) : 0;
    
    const entry = {
      idx,
      key,
      nom_mun: alc,
      colonia: col,
      cp: p.CP || "",
      gm_2020: p.GM_2020 || "",
      prio_colonia: (p.prioridad || "Sin dato").trim(),
      pob_colonia: pob,
      area_ha: area_km2 * 100,
      n_manz: manzanasPorColonia[key] || 0
    };
    coloniasAgg.push(entry);
  });

  // Calcular base global
  totalColoniasBase = coloniasAgg.length;
  totalPobBase = coloniasAgg.reduce((acc, e) => acc + e.pob_colonia, 0);
  totalHaBase  = coloniasAgg.reduce((acc, e) => acc + e.area_ha, 0);

  coloniasAgg.forEach(e => {
    const pr = normalizarPrioridad(e.prio_colonia);
    if (pr === "alta" || pr === "muy alta") {
      globalAltaMuyAltaColonias++;
      globalAltaMuyAltaPob += e.pob_colonia;
      globalAltaMuyAltaHa  += e.area_ha;
    }
  });
}

// =======================
// MAPA
// =======================

function initMap() {
  map = L.map('map').setView([19.35, -99.13], 11);

  baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' });
  baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '&copy; CARTO' });
  baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '&copy; Esri' });

  baseLight.addTo(map);
  baseOSM.addTo(map); // OSM encima como overlay transparente si se desea, o al rev√©s

  // Capas
  capaManzanasTodas = L.geoJSON(null, {
    pane: 'overlayPane',
    style: { color: "#888", weight: 0.3, fillColor: "#c0c0c0", fillOpacity: 0.25 }
  }).addTo(map);

  capaColonias = L.geoJSON(null, {
    pane: 'overlayPane',
    style: { color: "#5f6b73", weight: 1.2, fillOpacity: 0 },
    onEachFeature: (feat, layer) => {
      const p = feat.properties;
      indiceColonias[`${normalizarTexto(p.NOM_MUN)}|${normalizarTexto(p.COLONIA)}`] = layer;
    }
  }).addTo(map);

  capaManzanasResaltadas = L.geoJSON(null, {
    pane: 'overlayPane',
    style: (feature) => {
      const s = estiloPrioridad(feature.properties.PRIORIDAD);
      return { color: "#555", weight: 0.6, fillColor: s.fill, fillOpacity: 0.6 };
    },
    onEachFeature: (f, l) => {
      l.on('mouseover', () => actualizarPanelManzana(f.properties));
      l.on('click', () => actualizarPanelManzana(f.properties));
    }
  }).addTo(map);

  capaColoniasPrioridad = L.geoJSON(null, {
    pane: 'overlayPane',
    style: (f) => {
      const s = estiloPrioridad(f.properties.prioridad);
      return { color: s.color, weight: 2.2, fillColor: s.fill, fillOpacity: 0.15 };
    }
  }).addTo(map);

  capaManzanasPrioridad = L.geoJSON(null, {
    pane: 'overlayPane',
    style: (f) => {
      const s = estiloPrioridad(f.properties.PRIORIDAD);
      return { color: "#444", weight: 0.4, fillColor: s.fill, fillOpacity: 0.5 };
    }
  }).addTo(map);

  L.control.layers({
    "Calles (OSM)": baseOSM, "Calles claras": baseLight, "Sat√©lite": baseSat
  }, {
    "Colonias": capaColonias, "Manzanas": capaManzanasTodas
  }, { collapsed: true }).addTo(map);

  manzanaInfoControl = L.control({ position: 'topright' });
  manzanaInfoControl.onAdd = () => {
    const div = L.DomUtil.create('div', 'manzana-info');
    div.innerHTML = '<b>Selecci√≥n de manzana</b><p class="manzana-info-empty">Pasa el cursor para ver detalles.</p>';
    return div;
  };
  manzanaInfoControl.addTo(map);
}

function actualizarPanelManzana(p) {
  const div = manzanaInfoControl.getContainer();
  const badgeClass = prioridadClass(p.PRIORIDAD);
  div.className = 'manzana-info ' + badgeClass;
  div.innerHTML = `
    <b>${normalizarTexto(p.COLONIA)}</b><br>
    ID: ${p.CVEGEO}<br>
    Prioridad: <span class="badge-prioridad ${badgeClass}">${p.PRIORIDAD}</span><br>
    Pob: ${Number(p.POB).toLocaleString()} | Viv: ${Number(p.VIV).toLocaleString()}<br>
    Infraestructura: ${p.Inf_Azul || 'Sin dato'}
  `;
}

function limpiarPanelManzana() {
  const div = manzanaInfoControl.getContainer();
  div.className = 'manzana-info';
  div.innerHTML = '<b>Selecci√≥n de manzana</b><p class="manzana-info-empty">Pasa el cursor.</p>';
}

function cargarCapasEnMapa() {
  capaColonias.clearLayers();
  capaManzanasTodas.clearLayers();
  indiceColonias = {};
  
  capaManzanasTodas.addData(manzanasFeatures);
  capaColonias.addData(coloniasFeatures);
  
  if (capaColonias.getLayers().length) map.fitBounds(capaColonias.getBounds());
}

function aplicarFiltroPrioridadMapa(prio, target) {
  capaColoniasPrioridad.clearLayers();
  capaManzanasPrioridad.clearLayers();
  
  if (!prio) return;
  const prNorm = normalizarPrioridad(prio);

  if (target === 'colonias') {
    const feats = coloniasFeatures.filter(f => normalizarPrioridad(f.properties.prioridad) === prNorm);
    capaColoniasPrioridad.addData(feats);
    if(feats.length) map.fitBounds(capaColoniasPrioridad.getBounds());
  } else {
    const feats = manzanasFeatures.filter(f => normalizarPrioridad(f.properties.PRIORIDAD) === prNorm);
    capaManzanasPrioridad.addData(feats);
    if(feats.length) map.fitBounds(capaManzanasPrioridad.getBounds());
  }
}

// =======================
// TABLA Y UI
// =======================

function inicializarTablaColonias() {
  const poblarSelect = (id, key) => {
    const set = new Set(coloniasAgg.map(r => r[key]).filter(Boolean));
    const sel = document.getElementById(id);
    Array.from(set).sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v;
      sel.appendChild(opt);
    });
  };

  poblarSelect('filtroAlc', 'nom_mun');
  poblarSelect('filtroPrio', 'prio_colonia');
  poblarSelect('filtroGM', 'gm_2020');

  ['filtroAlc', 'filtroCol', 'filtroPrio', 'filtroGM'].forEach(id => {
    document.getElementById(id).addEventListener(id === 'filtroCol' ? 'input' : 'change', actualizarTablaColonias);
  });

  document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
    ['filtroAlc', 'filtroCol', 'filtroPrio', 'filtroGM'].forEach(id => document.getElementById(id).value = "");
    actualizarTablaColonias();
  });

  actualizarTablaColonias();
}

function actualizarTablaColonias() {
  const fAlc = document.getElementById('filtroAlc').value;
  const fCol = document.getElementById('filtroCol').value.toLowerCase();
  const fPrio = document.getElementById('filtroPrio').value;
  const fGM = document.getElementById('filtroGM').value;

  let filas = coloniasAgg.filter(r => 
    (!fAlc || r.nom_mun === fAlc) &&
    (!fCol || r.colonia.toLowerCase().includes(fCol)) &&
    (!fPrio || r.prio_colonia === fPrio) &&
    (!fGM || r.gm_2020 === fGM)
  );

  // Ordenamiento b√°sico
  if (currentSort.col) {
    const {col, dir} = currentSort;
    const m = dir === 'asc' ? 1 : -1;
    filas.sort((a,b) => {
      if (['n_manz','pob_colonia','area_ha'].includes(col)) return (a[col] - b[col]) * m;
      return String(a[col]).localeCompare(String(b[col])) * m;
    });
  }

  const tbody = document.querySelector('#tablaColonias tbody');
  let html = "";
  filas.forEach(r => {
    html += `<tr data-idx="${r.idx}">
      <td>${r.nom_mun}</td>
      <td>
        ${r.colonia}<br>
        <a href="https://www.google.com/maps/search/?api=1&query=Colonia+${r.colonia}+${r.nom_mun}+CDMX" target="_blank" class="gmaps-link">Ver en Maps</a>
      </td>
      <td>${r.n_manz}</td>
      <td><span class="prio-dot ${prioridadClass(r.prio_colonia)}"></span>${r.prio_colonia}</td>
      <td>${r.gm_2020}</td>
      <td>${r.pob_colonia.toLocaleString()}</td>
      <td>${r.area_ha.toFixed(2)}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
  
  actualizarKPIsyCharts(filas);
}

function actualizarKPIsyCharts(filas) {
  // KPIs base
  document.getElementById('kpiTotalColonias').textContent = totalColoniasBase.toLocaleString();
  document.getElementById('kpiColoniasAlta').textContent = globalAltaMuyAltaColonias.toLocaleString();
  document.getElementById('kpiPobAlta').textContent = globalAltaMuyAltaPob.toLocaleString();
  document.getElementById('kpiHaAlta').textContent = globalAltaMuyAltaHa.toLocaleString(undefined, {maximumFractionDigits:1});
  
  // Resumen tabla
  const contexto = textoContextoFiltros();
  document.getElementById('tablaResumen').textContent = `Mostrando ${filas.length} de ${totalColoniasBase} colonias (${contexto}).`;

  // Datos Gr√°ficas
  const conteo = {}, pob = {};
  ["muy alta","alta","media","baja","muy baja"].forEach(k => { conteo[k]=0; pob[k]=0; });
  
  filas.forEach(r => {
    const p = normalizarPrioridad(r.prio_colonia);
    if (conteo[p] !== undefined) {
      conteo[p]++;
      pob[p] += r.pob_colonia;
    }
  });

  const labels = Object.keys(conteo).map(s => s.charAt(0).toUpperCase() + s.slice(1));
  const dataC = Object.values(conteo);
  const dataP = Object.values(pob);
  const colors = ["#ff2200", "#ff9900", "#ffff00", "#7aab00", "#006100"]; // Orden coincide con keys arriba? No, keys: Muy Alta -> Muy Baja

  // Actualizar Chart.js
  if (chartColonias) chartColonias.destroy();
  chartColonias = new Chart(document.getElementById('chartColonias'), {
    type: 'bar',
    data: { labels, datasets: [{ data: dataC, backgroundColor: colors }] },
    options: { plugins: { legend: { display: false } } }
  });

  if (chartPoblacion) chartPoblacion.destroy();
  chartPoblacion = new Chart(document.getElementById('chartPoblacion'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data: dataP, backgroundColor: colors }] },
    options: { plugins: { legend: { position: 'right' } } }
  });
}

function resaltarColoniaYManzanas(entry) {
  showMapLoading(true);
  setTimeout(() => {
    const layer = indiceColonias[entry.key];
    if (layer) {
      capaColonias.resetStyle();
      const s = estiloPrioridad(entry.prio_colonia);
      layer.setStyle({ color: s.color, weight: 3, fillOpacity: 0 });
      layer.openPopup();
      map.fitBounds(layer.getBounds());
      
      // Filtrar manzanas visualmente (usando Turf para intersecci√≥n precisa o bbox simple para rapidez)
      const colGeo = layer.toGeoJSON();
      const manzSel = manzanasFeatures.filter(f => turf.booleanIntersects(f, colGeo));
      capaManzanasResaltadas.clearLayers().addData(manzSel);
    }
    showMapLoading(false);
  }, 50);
}

// =======================
// INICIO
// =======================
document.addEventListener('DOMContentLoaded', () => {
  initMap();

  // Cargar datos
  Promise.all([
    fetch('colonias_manzanas_verdes.geojson').then(r => r.json()),
    fetch('manzanas_manzanas_verdes.geojson').then(r => r.json())
  ]).then(([colData, manzData]) => {
    coloniasFeatures = colData.features;
    manzanasFeatures = manzData.features;
    
    construirAgregadosColonias();
    cargarCapasEnMapa();
    inicializarTablaColonias();

    // Llenar selector de alcald√≠as principal
    const sel = document.getElementById('munSelector');
    const alcs = [...new Set(coloniasAgg.map(c => c.nom_mun))].sort();
    alcs.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a; opt.textContent = a;
      sel.appendChild(opt);
    });

  }).catch(e => console.error("Error cargando GeoJSON:", e));

  // Eventos UI
  document.getElementById('munSelector').addEventListener('change', (e) => {
    const alc = e.target.value;
    const dl = document.getElementById('colList');
    const inp = document.getElementById('colInput');
    dl.innerHTML = '';
    inp.value = '';
    inp.disabled = !alc;
    
    if (alc) {
      coloniasAgg.filter(c => c.nom_mun === alc).sort((a,b)=>a.colonia.localeCompare(b.colonia))
        .forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.colonia;
          dl.appendChild(opt);
        });
    }
  });

  document.getElementById('colInput').addEventListener('change', (e) => {
    const val = e.target.value;
    const alc = document.getElementById('munSelector').value;
    const found = coloniasAgg.find(c => c.nom_mun === alc && c.colonia === val);
    
    if (found) {
      const div = document.getElementById('resultado');
      div.style.display = 'block';
      div.innerHTML = `
        <div class="kpi-card">
          <h4>${found.colonia} (${found.nom_mun})</h4>
          <p>Prioridad: <span class="badge-prioridad ${prioridadClass(found.prio_colonia)}">${found.prio_colonia}</span></p>
          <p>Manzanas: ${found.n_manz} | Pob: ${found.pob_colonia.toLocaleString()}</p>
        </div>`;
      resaltarColoniaYManzanas(found);
    }
  });

  document.getElementById('tablaColonias').addEventListener('click', (e) => {
    const tr = e.target.closest('tr');
    if (tr && tr.dataset.idx) {
      const idx = tr.dataset.idx;
      const found = coloniasAgg.find(c => c.idx == idx);
      if (found) resaltarColoniaYManzanas(found);
    }
  });

  document.getElementById('btnFullscreen').addEventListener('click', () => {
    document.getElementById('mapWrapper').classList.toggle('map-fullscreen');
    setTimeout(() => map.invalidateSize(), 300);
  });

  // Filtros de leyenda
  document.querySelectorAll('.legend-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const isActive = btn.classList.contains('active');
      document.querySelectorAll('.legend-btn').forEach(b => b.classList.remove('active'));
      
      if (!isActive) {
        btn.classList.add('active');
        aplicarFiltroPrioridadMapa(btn.dataset.prio, btn.dataset.target);
      } else {
        aplicarFiltroPrioridadMapa(null, null);
      }
    });
  });
});
</script>
</body>
</html>
