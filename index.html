<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEDEMA ¬∑ Manzanas por colonia</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Control Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  
  <!-- Fuente Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Estilos propios -->
  <link href="styles.css" rel="stylesheet" />
</head>
<body>

<header>
  <div class="header-inner">
    <div class="header-logos">
      <img src="logo_manzanas_verdes.png" alt="SEDEMA ¬∑ Manzanas Verdes" class="logo-sedema-manzanas">
    </div>
    <div class="header-texto">
      <h1>SEDEMA ¬∑ Manzanas por colonia</h1>
      <p>Herramienta para consultar manzanas y prioridad de intervenci√≥n por colonia en la Ciudad de M√©xico.</p>
    </div>
  </div>
  <div class="linea-oro"></div>
</header>

<main class="container">

  <!-- KPIs globales (Dise√±o mejorado) -->
  <section class="kpi-global-section">
    <div class="kpi-global-card">
      <div class="kpi-icon">üèôÔ∏è</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Colonias Totales</div>
        <div id="kpiTotalColonias" class="kpi-global-value">...</div>
      </div>
    </div>
    <div class="kpi-global-card alert">
      <div class="kpi-icon">‚ö†Ô∏è</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Colonias Alta + Muy Alta</div>
        <div id="kpiColoniasAlta" class="kpi-global-value">...</div>
      </div>
    </div>
    <div class="kpi-global-card alert">
      <div class="kpi-icon">üë•</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Poblaci√≥n Prioritaria</div>
        <div id="kpiPobAlta" class="kpi-global-value">...</div>
      </div>
    </div>
    <div class="kpi-global-card">
      <div class="kpi-icon">üìê</div>
      <div class="kpi-content">
        <div class="kpi-global-label">Superficie Prioritaria (ha)</div>
        <div id="kpiHaAlta" class="kpi-global-value">...</div>
      </div>
    </div>
  </section>

  <!-- Consulta -->
  <section class="section-block">
    <h2>Consulta por alcald√≠a y colonia</h2>
    <div class="form-grid">
      <div class="form-item">
        <label for="munSelector">Alcald√≠a</label>
        <select id="munSelector"><option value="">Selecciona alcald√≠a...</option></select>
        <small class="hint">Filtra la lista de colonias.</small>
      </div>
      <div class="form-item">
        <label for="colInput">Colonia</label>
        <input id="colInput" list="colList" placeholder="Escribe el nombre de la colonia‚Ä¶" disabled>
        <datalist id="colList"></datalist>
        <small class="hint">Selecciona de la lista desplegable.</small>
      </div>
    </div>
  </section>

  <!-- MAPA -->
  <section class="map-section section-block">
    <div class="map-header">
      <h3>Mapa de colonias y manzanas</h3>
      <button id="btnFullscreen" class="btn-fullscreen">‚§¢ Pantalla completa</button>
    </div>

    <div class="map-wrapper" id="mapWrapper">
      <div id="map"></div>
      <div id="mapLoading" class="map-loading">Cargando y procesando datos...</div>

      <!-- LEYENDA -->
      <div class="map-legend">
        <div class="legend-title">Simbolog√≠a</div>
        
        <div class="legend-group">
          <div class="legend-item">
            <span class="legend-color colonias-color"></span>
            <span class="legend-label">L√≠mite Colonia</span>
          </div>
          <div class="legend-item">
            <span class="legend-color manzanas-sel-color"></span>
            <span class="legend-label">Manzanas (Selecci√≥n)</span>
          </div>
        </div>

        <div class="legend-subtitle">Prioridad (Filtros)</div>
        <div class="legend-group">
          <!-- Muy Baja -->
          <div class="legend-row">
            <div class="legend-info">
              <span class="legend-color prio-muy-baja"></span>
              <span class="legend-label">Muy baja</span>
            </div>
            <div class="legend-actions">
              <button class="legend-btn" data-prio="muy baja" data-target="colonias">Col.</button>
              <button class="legend-btn" data-prio="muy baja" data-target="manzanas">Manz.</button>
            </div>
          </div>
          <!-- Baja -->
          <div class="legend-row">
            <div class="legend-info">
              <span class="legend-color prio-baja"></span>
              <span class="legend-label">Baja</span>
            </div>
            <div class="legend-actions">
              <button class="legend-btn" data-prio="baja" data-target="colonias">Col.</button>
              <button class="legend-btn" data-prio="baja" data-target="manzanas">Manz.</button>
            </div>
          </div>
          <!-- Media -->
          <div class="legend-row">
            <div class="legend-info">
              <span class="legend-color prio-media"></span>
              <span class="legend-label">Media</span>
            </div>
            <div class="legend-actions">
              <button class="legend-btn" data-prio="media" data-target="colonias">Col.</button>
              <button class="legend-btn" data-prio="media" data-target="manzanas">Manz.</button>
            </div>
          </div>
          <!-- Alta -->
          <div class="legend-row">
            <div class="legend-info">
              <span class="legend-color prio-alta"></span>
              <span class="legend-label">Alta</span>
            </div>
            <div class="legend-actions">
              <button class="legend-btn" data-prio="alta" data-target="colonias">Col.</button>
              <button class="legend-btn" data-prio="alta" data-target="manzanas">Manz.</button>
            </div>
          </div>
          <!-- Muy Alta -->
          <div class="legend-row">
            <div class="legend-info">
              <span class="legend-color prio-muy-alta"></span>
              <span class="legend-label">Muy alta</span>
            </div>
            <div class="legend-actions">
              <button class="legend-btn" data-prio="muy alta" data-target="colonias">Col.</button>
              <button class="legend-btn" data-prio="muy alta" data-target="manzanas">Manz.</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TABLA -->
  <section class="table-section section-block">
    <div class="table-header-row">
      <h3>Colonias ‚Äì Indicadores</h3>
      <button id="btnLimpiarFiltros" class="btn-clear-table">
        üîÑ Restablecer Filtros
      </button>
    </div>
    
    <p id="tablaResumen" class="tabla-resumen"></p>

    <div class="table-wrapper">
      <table id="tablaColonias">
        <thead>
          <tr>
            <th data-col="alc">Alcald√≠a ‚Üï<br><select id="filtroAlc"><option value="">Todas</option></select></th>
            <th data-col="col">Colonia ‚Üï<br><input id="filtroCol" type="text" placeholder="Buscar..."></th>
            <th data-col="manz">No. Manzanas ‚Üï</th>
            <th data-col="prio">Prioridad ‚Üï<br><select id="filtroPrio"><option value="">Todas</option></select></th>
            <th data-col="gm">Grado Marg. ‚Üï<br><select id="filtroGM"><option value="">Todos</option></select></th>
            <th data-col="pob">Poblaci√≥n ‚Üï</th>
            <th data-col="ha">Superficie (ha) ‚Üï</th>
          </tr>
        </thead>
        <tbody><!-- JS rellena esto --></tbody>
      </table>
    </div>
    <section id="statsResumen" class="stats-section"></section>
  </section>

  <!-- GR√ÅFICAS -->
  <section class="analysis-section section-block">
    <h3>Distribuci√≥n por prioridad (Datos filtrados)</h3>
    <div class="charts-wrapper">
      <div class="chart-card">
        <h4 id="chartTitleColonias">Colonias</h4>
        <div class="chart-container-box">
          <canvas id="chartColonias"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h4 id="chartTitlePoblacion">Poblaci√≥n</h4>
        <div class="chart-container-box">
          <canvas id="chartPoblacion"></canvas>
        </div>
      </div>
    </div>
  </section>

</main>

<footer>
  <p>SEDEMA ¬∑ Herramienta de consulta interna.</p>
</footer>

<!-- JS Libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Plugin Geocoder -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// =======================
// JS LOGIC
// =======================
let coloniasFeatures = [], manzanasFeatures = [], coloniasAgg = [];
let map, baseOSM, baseLight, baseSat, baseEmpty;
let capaColonias, capaManzanasTodas, capaManzanasResaltadas;
let capaColoniasPrioridad, capaManzanasPrioridad;
let indiceColonias = {};
let manzanaInfoControl;
let currentSort = { col: null, dir: 'asc' };
let chartColonias = null, chartPoblacion = null;

// Helpers
function normalizarTexto(str) {
  if (!str) return "";
  const fixes = { "TL?HUAC": "TL√ÅHUAC", "?LVARO OBREG?N": "√ÅLVARO OBREG√ìN" };
  const raw = String(str).trim();
  return fixes[raw] || raw;
}
function normalizarPrioridad(str) { return (str || "").toString().toLowerCase().trim(); }
function prioridadClass(p) {
  const pr = normalizarPrioridad(p);
  if (pr === "muy baja") return "prio-muy-baja";
  if (pr === "baja") return "prio-baja";
  if (pr === "media") return "prio-media";
  if (pr === "alta") return "prio-alta";
  if (pr === "muy alta") return "prio-muy-alta";
  return "prio-desconocida";
}
function estiloPrioridad(p) {
  const c = { "muy baja":"#006100", "baja":"#7aab00", "media":"#ffff00", "alta":"#ff9900", "muy alta":"#ff2200" };
  const k = normalizarPrioridad(p);
  return { color: c[k] || "#ccc", fill: c[k] || "#ccc" };
}
function showMapLoading(show) { 
  const el = document.getElementById('mapLoading'); if(el) el.style.display = show ? 'flex':'none'; 
}

// =======================
// MAPA (Configuraci√≥n Experta)
// =======================
function initMap() {
  map = L.map('map').setView([19.35, -99.13], 11);

  // 1. Mapas Base (Restaurados)
  baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OSM' });
  baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© CARTO' });
  baseSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: '¬© Esri' });
  baseEmpty = L.layerGroup(); // Mapa vac√≠o

  baseLight.addTo(map); // Default

  // 2. Renderer Canvas (Rendimiento)
  // Esto hace que miles de manzanas se rendericen como una imagen √∫nica, mucho m√°s r√°pido.
  const myRenderer = L.canvas({ padding: 0.5 });

  // 3. Capas
  capaManzanasTodas = L.geoJSON(null, {
    renderer: myRenderer, // <--- CLAVE PARA RENDIMIENTO
    style: { color: "#999", weight: 0.2, fillColor: "#ccc", fillOpacity: 0.2 }
  }); // No a√±adir por defecto para limpiar vista inicial si se desea, o a√±adir: .addTo(map);
  capaManzanasTodas.addTo(map);

  capaColonias = L.geoJSON(null, {
    style: { color: "#5f6b73", weight: 1.5, fillOpacity: 0 },
    onEachFeature: (f, l) => {
      const p = f.properties;
      const key = `${normalizarTexto(p.NOM_MUN)}|${normalizarTexto(p.COLONIA)}`;
      indiceColonias[key] = l;
    }
  }).addTo(map);

  capaManzanasResaltadas = L.geoJSON(null, {
    renderer: myRenderer,
    style: f => {
      const s = estiloPrioridad(f.properties.PRIORIDAD);
      return { color: "#444", weight: 0.5, fillColor: s.fill, fillOpacity: 0.6 };
    },
    onEachFeature: (f, l) => {
      l.on('mouseover', () => actualizarPanelManzana(f.properties));
      l.on('click', () => actualizarPanelManzana(f.properties));
    }
  }).addTo(map);

  // Capas de Filtro (Leyenda)
  capaColoniasPrioridad = L.geoJSON(null, {
    style: f => ({ color: estiloPrioridad(f.properties.prioridad).color, weight: 2, fillOpacity: 0.2 })
  }).addTo(map);

  capaManzanasPrioridad = L.geoJSON(null, {
    renderer: myRenderer,
    style: f => ({ color: "#444", weight: 0.2, fillColor: estiloPrioridad(f.properties.PRIORIDAD).fill, fillOpacity: 0.5 })
  }).addTo(map);

  // 4. Control de Capas (Restaurado)
  const baseMaps = { "Claro (Carto)": baseLight, "Sat√©lite (Esri)": baseSat, "Calles (OSM)": baseOSM, "Sin mapa": baseEmpty };
  const overlayMaps = { "Colonias": capaColonias, "Manzanas (Todas)": capaManzanasTodas };
  L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

  // 5. Geocodificador (Buscador de direcciones)
  L.Control.geocoder({
    defaultMarkGeocode: false,
    placeholder: "Buscar direcci√≥n..."
  })
  .on('markgeocode', function(e) {
    const bbox = e.geocode.bbox;
    const poly = L.polygon([
      bbox.getSouthEast(), bbox.getNorthEast(),
      bbox.getNorthWest(), bbox.getSouthWest()
    ]);
    map.fitBounds(poly.getBounds());
    L.popup().setLatLng(e.geocode.center).setContent(e.geocode.name).openOn(map);
  })
  .addTo(map);

  // 6. Bot√≥n "Mi Ubicaci√≥n"
  const locateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
      const btn = L.DomUtil.create('button', 'btn-locate');
      btn.innerHTML = 'üìç';
      btn.title = "Mi ubicaci√≥n";
      btn.style.backgroundColor = "white";
      btn.style.width = "30px";
      btn.style.height = "30px";
      btn.style.border = "2px solid rgba(0,0,0,0.2)";
      btn.style.borderRadius = "4px";
      btn.style.cursor = "pointer";
      btn.style.fontSize = "16px";
      
      btn.onclick = () => {
        map.locate({setView: true, maxZoom: 16});
      };
      return btn;
    }
  });
  map.addControl(new locateControl());

  map.on('locationfound', e => {
    L.circle(e.latlng, { radius: e.accuracy/2, color:'#007a4d' }).addTo(map);
    L.popup().setLatLng(e.latlng).setContent("Est√°s aqu√≠").openOn(map);
  });
  map.on('locationerror', () => alert("No se pudo obtener tu ubicaci√≥n."));

  // 7. Panel Manzana Info
  manzanaInfoControl = L.control({ position: 'topright' });
  manzanaInfoControl.onAdd = () => {
    const div = L.DomUtil.create('div', 'manzana-info');
    div.innerHTML = '<b>Info. Manzana</b><br><i>Pasa el cursor...</i>';
    return div;
  };
  manzanaInfoControl.addTo(map);
}

function actualizarPanelManzana(p) {
  const div = manzanaInfoControl.getContainer();
  const cls = prioridadClass(p.PRIORIDAD);
  div.className = 'manzana-info ' + cls;
  div.innerHTML = `<b>Manzana:</b> ${p.CVEGEO || ''}<br>
    <b>Colonia:</b> ${normalizarTexto(p.COLONIA)}<br>
    <b>Prioridad:</b> <span class="badge-prioridad ${cls}">${p.PRIORIDAD}</span><br>
    <b>Pob:</b> ${Number(p.POB).toLocaleString()}<br>
    <b>Viv:</b> ${Number(p.VIV).toLocaleString()}<br>
    <small>${p.Inf_Azul || ''}</small>`;
}

// =======================
// L√ìGICA PRINCIPAL
// =======================
function resaltarColoniaYManzanas(entry) {
  if (!entry) return;
  const layer = indiceColonias[entry.key];
  if (!layer) return alert("Geometr√≠a no encontrada en el mapa.");

  showMapLoading(true);
  
  capaColonias.resetStyle();
  capaColonias.eachLayer(l => { l.unbindPopup(); l.closePopup(); });

  const s = estiloPrioridad(entry.prio_colonia);
  layer.setStyle({ color: s.color, weight: 3, fillOpacity: 0 });

  const prClass = prioridadClass(entry.prio_colonia);
  const html = `
    <div class="popup-colonia-wrapper">
      <div class="popup-colonia-header ${prClass}">
        ${normalizarTexto(entry.colonia)}
      </div>
      <div class="popup-colonia-body">
        <b>Alcald√≠a:</b> ${normalizarTexto(entry.nom_mun)}<br>
        <b>Prioridad:</b> <span class="badge-prioridad ${prClass}">${entry.prio_colonia}</span><br>
        <b>G. Marginaci√≥n:</b> ${entry.gm_2020 || 'N/D'}<br>
        <b>Manzanas:</b> ${entry.n_manz}<br>
        <b>Poblaci√≥n:</b> ${entry.pob_colonia.toLocaleString()}<br>
        <b>√Årea:</b> ${entry.area_ha.toFixed(2)} ha
      </div>
    </div>`;

  layer.bindPopup(html, { className: 'popup-colonia', minWidth: 200 }).openPopup();
  map.fitBounds(layer.getBounds(), { padding: [20,20] });

  setTimeout(() => {
    const geo = layer.toGeoJSON();
    // Filtro espacial usando Turf
    const matches = manzanasFeatures.filter(f => {
       try { return turf.booleanIntersects(f, geo); } catch(e){ return false; }
    });
    capaManzanasResaltadas.clearLayers().addData(matches);
    showMapLoading(false);
  }, 50);
}

function initData() {
  Promise.all([
    fetch('colonias_manzanas_verdes.geojson').then(r=>r.json()),
    fetch('manzanas_manzanas_verdes.geojson').then(r=>r.json())
  ]).then(([colD, manzD]) => {
    coloniasFeatures = colD.features;
    manzanasFeatures = manzD.features;
    
    capaColonias.addData(coloniasFeatures);
    capaManzanasTodas.addData(manzanasFeatures);

    const counts = {};
    manzanasFeatures.forEach(f => {
      const k = `${normalizarTexto(f.properties.NOM_MUN)}|${normalizarTexto(f.properties.COLONIA)}`;
      counts[k] = (counts[k] || 0) + 1;
    });

    coloniasAgg = coloniasFeatures.map((f, i) => {
      const p = f.properties;
      const k = `${normalizarTexto(p.NOM_MUN)}|${normalizarTexto(p.COLONIA)}`;
      return {
        idx: i, key: k,
        nom_mun: normalizarTexto(p.NOM_MUN),
        colonia: normalizarTexto(p.COLONIA),
        prio_colonia: (p.prioridad || "Sin dato").trim(),
        gm_2020: p.GM_2020 || "",
        pob_colonia: p.POBTOT ? Math.round(p.POBTOT) : 0,
        area_ha: (p.area_km2 || 0) * 100,
        n_manz: counts[k] || 0
      };
    });

    // KPIs Header
    document.getElementById('kpiTotalColonias').innerText = coloniasAgg.length.toLocaleString();
    const altas = coloniasAgg.filter(c => ["alta","muy alta"].includes(normalizarPrioridad(c.prio_colonia)));
    document.getElementById('kpiColoniasAlta').innerText = altas.length.toLocaleString();
    document.getElementById('kpiPobAlta').innerText = altas.reduce((a,b)=>a+b.pob_colonia,0).toLocaleString();
    document.getElementById('kpiHaAlta').innerText = altas.reduce((a,b)=>a+b.area_ha,0).toLocaleString(undefined,{maximumFractionDigits:1});

    // Selects
    const alcs = [...new Set(coloniasAgg.map(c=>c.nom_mun))].sort();
    alcs.forEach(a => {
      document.getElementById('munSelector').add(new Option(a,a));
      document.getElementById('filtroAlc').add(new Option(a,a));
    });
    const prios = [...new Set(coloniasAgg.map(c=>c.prio_colonia))].sort();
    prios.forEach(p => document.getElementById('filtroPrio').add(new Option(p,p)));
    const gms = [...new Set(coloniasAgg.map(c=>c.gm_2020))].sort();
    gms.forEach(g => document.getElementById('filtroGM').add(new Option(g,g)));

    actualizarTabla();
  });
}

function actualizarTabla() {
  const fAlc = document.getElementById('filtroAlc').value;
  const fCol = document.getElementById('filtroCol').value.toLowerCase();
  const fPrio = document.getElementById('filtroPrio').value;
  const fGM = document.getElementById('filtroGM').value;

  let d = coloniasAgg.filter(r => 
    (!fAlc || r.nom_mun === fAlc) &&
    (!fCol || r.colonia.toLowerCase().includes(fCol)) &&
    (!fPrio || r.prio_colonia === fPrio) &&
    (!fGM || r.gm_2020 === fGM)
  );

  if (currentSort.col) {
    const {col, dir} = currentSort;
    const m = dir === 'asc' ? 1 : -1;
    d.sort((a,b) => {
      const va=a[col], vb=b[col];
      return (typeof va === 'number' ? va-vb : String(va).localeCompare(String(vb))) * m;
    });
  }

  const tbody = document.querySelector('#tablaColonias tbody');
  let html = "";
  d.forEach(r => {
    html += `<tr data-idx="${r.idx}">
      <td>${r.nom_mun}</td>
      <td>${r.colonia}</td>
      <td>${r.n_manz}</td>
      <td><span class="prio-dot ${prioridadClass(r.prio_colonia)}"></span>${r.prio_colonia}</td>
      <td>${r.gm_2020}</td>
      <td>${r.pob_colonia.toLocaleString()}</td>
      <td>${r.area_ha.toFixed(2)}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
  document.getElementById('tablaResumen').innerText = `Mostrando ${d.length} colonias.`;
  actualizarGraficas(d);
}

function actualizarGraficas(d) {
  const c = { "muy alta":0, "alta":0, "media":0, "baja":0, "muy baja":0 };
  const p = { "muy alta":0, "alta":0, "media":0, "baja":0, "muy baja":0 };
  
  d.forEach(i => {
    const k = normalizarPrioridad(i.prio_colonia);
    if(c[k] !== undefined) { c[k]++; p[k] += i.pob_colonia; }
  });

  const labels = Object.keys(c).map(s=>s.toUpperCase());
  const colors = ["#ff2200", "#ff9900", "#ffff00", "#7aab00", "#006100"];

  if(chartColonias) chartColonias.destroy();
  chartColonias = new Chart(document.getElementById('chartColonias'), {
    type: 'bar', data: { labels, datasets:[{ data:Object.values(c), backgroundColor:colors }] },
    options: { 
      responsive: true, maintainAspectRatio: false, // CLAVE PARA TAMA√ëO
      plugins: { legend: { display:false } } 
    }
  });

  if(chartPoblacion) chartPoblacion.destroy();
  chartPoblacion = new Chart(document.getElementById('chartPoblacion'), {
    type: 'doughnut', data: { labels, datasets:[{ data:Object.values(p), backgroundColor:colors }] },
    options: { 
      responsive: true, maintainAspectRatio: false, // CLAVE PARA TAMA√ëO
      plugins: { legend: { position:'right' } } 
    }
  });
}

// INICIO
document.addEventListener('DOMContentLoaded', () => {
  initMap();
  initData();

  ['filtroAlc','filtroCol','filtroPrio','filtroGM'].forEach(id => 
    document.getElementById(id).addEventListener(id==='filtroCol'?'input':'change', actualizarTabla));
  
  document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
    ['filtroAlc','filtroCol','filtroPrio','filtroGM'].forEach(id => document.getElementById(id).value = "");
    actualizarTabla();
  });

  document.querySelector('#tablaColonias tbody').addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if(tr && tr.dataset.idx) {
      const item = coloniasAgg.find(i => i.idx == tr.dataset.idx);
      resaltarColoniaYManzanas(item);
      document.getElementById('map').scrollIntoView({behavior:'smooth'});
    }
  });

  document.getElementById('munSelector').addEventListener('change', e => {
    const alc = e.target.value;
    const l = document.getElementById('colList');
    const i = document.getElementById('colInput');
    l.innerHTML = ''; i.value = ''; i.disabled = !alc;
    if(alc) {
      coloniasAgg.filter(c=>c.nom_mun===alc).sort((a,b)=>a.colonia.localeCompare(b.colonia))
        .forEach(c => l.appendChild(new Option(c.colonia)));
    }
  });

  document.getElementById('colInput').addEventListener('change', e => {
    const alc = document.getElementById('munSelector').value;
    const item = coloniasAgg.find(c => c.nom_mun===alc && c.colonia===e.target.value);
    if(item) resaltarColoniaYManzanas(item);
  });

  // LOGICA LEYENDA BOTONES (Corregida)
  document.querySelectorAll('.legend-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const isActive = btn.classList.contains('active');
      
      // 1. Limpiar todo
      document.querySelectorAll('.legend-btn').forEach(b => b.classList.remove('active'));
      capaColoniasPrioridad.clearLayers();
      capaManzanasPrioridad.clearLayers();

      // 2. Si no estaba activo, activar
      if (!isActive) {
        btn.classList.add('active');
        const p = btn.dataset.prio;
        const target = btn.dataset.target;
        
        if (target === 'colonias') {
          const filtered = coloniasFeatures.filter(f => normalizarPrioridad(f.properties.prioridad) === p);
          capaColoniasPrioridad.addData(filtered);
        } else {
          const filtered = manzanasFeatures.filter(f => normalizarPrioridad(f.properties.PRIORIDAD) === p);
          capaManzanasPrioridad.addData(filtered);
        }
      }
    });
  });

  document.getElementById('btnFullscreen').addEventListener('click', () => {
    document.getElementById('mapWrapper').classList.toggle('map-fullscreen');
    setTimeout(() => map.invalidateSize(), 300);
  });
});
</script>
</body>
</html>
